FROM php:7.0-fpm-alpine

RUN apk update && apk add php7-dev g++ make wget tar \
    && apk add --no-cache libpng-dev libjpeg-turbo-dev freetype-dev icu-dev

# Copy custom php.ini
COPY php.ini /usr/local/etc/php/conf.d/

# Install necessary PHP extensions
RUN docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/
RUN docker-php-ext-install gd mbstring opcache intl json zip bcmath pdo pdo_mysql

# Copy Xdebug source files from your local machine to the container
COPY xdebug-2.5.5.tgz /tmp/xdebug-2.5.5.tgz

# Extract Xdebug source files and build
RUN cd /tmp && \
    tar -xf xdebug-2.5.5.tgz && \
    rm xdebug-2.5.5.tgz && \
    cd xdebug-2.5.5 && \
    phpize && \
    ./configure && \
    make && \
    cp modules/xdebug.so /usr/local/lib/php/extensions/no-debug-non-zts-20151012/xdebug.so

# Copy Xdebug settings to a separate file
COPY xdebug.ini /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini

CMD ["php-fpm"]